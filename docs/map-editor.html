<html>
  <body>
    <main class="container">
      <div class="controls">
        <div class="control"><div class="control-cell cell normal selected"></div>normal</div>
        <div class="control"><div class="control-cell cell hole"></div>hole</div>
        <div class="control"><div class="control-cell cell mine"></div>mine</div>
        <div class="control"><div class="control-cell cell human-base"></div>human base</div>
        <div class="control"><div class="control-cell cell cpu-base"></div>cpu base</div>
      </div>

      <section class="map"></section>
      <section class="data">
        <pre></pre>
        <pre class="encode"></pre>
      </section>
    </main>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font: 14px sans-serif;
        padding: 20px;
      }

      .container {
        display: flex;
      }

      .map {
        margin-right: 30px;
      }

      .data {
        max-width: 860px;
        overflow: hidden;
      }

      .data pre {
        background: #eee;
        font-size: 10px;
        margin-bottom: 20px;
        padding: 20px;
      }

      .encode {
        word-break: break-all;
      }

      .row {
        display: flex;
      }

      .cell {
        border: 1px solid #8883;
        cursor: pointer;
        display: inline-block;
        height: 20px;
        position: relative;
        width: 20px;
      }

      .cell.thickX {
        border-top: 3px solid #8888;
      }

      .cell.thickY {
        border-left: 3px solid #8888;
      }

      .hole, [data-type="hole"] {
        background: #333;
      }

      .mine, [data-type="mine"] {
        background: #369;
      }
      .map [data-type="mine"]:after {
        background: #369c;
        content: "";
        height: 40px;
        position: absolute;
        width: 40px;
      }

      .human-base, [data-type="human-base"] {
        background: #A00;
      }
      .map [data-type="human-base"]:after {
        background: #A00c;
        content: "";
        height: 60px;
        position: absolute;
        width: 60px;
      }

      .cpu-base, [data-type="cpu-base"] {
        background: #00A;
      }
      .map [data-type="cpu-base"]:after {
        background: #00Ac;
        content: "";
        height: 60px;
        position: absolute;
        width: 60px;
      }

      .controls {
        margin-right: 20px;
        width: 500px;
      }

      .control {
        margin-bottom: 10px;
      }

      .control-cell {
        margin-right: 10px;
      }

      .selected {
        border: 3px solid red;
      }

    </style>

    <script>
      const SIZE = 48
      const TILE_TYPES = ["normal", "hole", "mine", "human-base", "cpu-base"];
      const map_div = document.querySelector(".map");
      const data_pre = document.querySelector(".data pre");
      const data_encode = document.querySelector(".data .encode");
      const controls = document.querySelectorAll(".controls .control-cell");

      let selected_control = TILE_TYPES[0];
      let get_selected_control = () => selected_control;
      let selecting = false;
      document.body.onmousedown = () => { selecting = true; }
      document.body.onmouseup = () => { selecting = false; }

      const encode = (m) => {
        const binary = m.map(r => r.join("")).join("").replaceAll(/[2-4]/g, 0);
        const bytes = binary.match(/.{1,8}/g);
        const hex = bytes.map(b => parseInt(b, 2).toString(16));
        const byteString = hex.map(h => ("\\x" + (h.length === 1 ? "0" + h : h))).join("")
        const encoded = btoa(eval(`"${byteString}"`));
        return encoded;
      }

      const decode = (encoded) => {
        const decoded = atob(encoded);
        const pad = n => ("00000000".substr(n.length) + n);
        const chars = decoded.split("").map(c => pad(c.charCodeAt(0).toString(2))).join("");
        const rows = chars.match(/.{1,48}/g).map(r => Array.from(r).map(c => Number(c)));
        return rows;
      }

      const load_map = () => {
        const encoded_map = window.localStorage.getItem('map');

        if (encoded_map) {
          let { levelData, mines, humanBases, cpuBases } = JSON.parse(encoded_map);
          levelData = decode(levelData);
          Object.keys(mines).forEach((m) => {
            const [x, y] = JSON.parse(m);
            levelData[y][x] = 2
          });
          Object.keys(humanBases).forEach((m) => {
            const [x, y] = JSON.parse(m);
            levelData[y][x] = 3
          });
          Object.keys(cpuBases).forEach((m) => {
            const [x, y] = JSON.parse(m);
            levelData[y][x] = 4
          });
          return { levelData, mines, humanBases, cpuBases };
        }

        const map_row = Array(SIZE).fill(0);
        const map = Array(SIZE).fill(0).map((row) => [...map_row]);
        return { levelData: map, mines: {}, humanBases: {}, cpuBases: {} };
      }

      const { levelData, mines, humanBases, cpuBases } = load_map();
      const map = levelData;

      const render_row = (row) => `<div class="row">${row}</div>`;

      const render_map = (map) =>
        map.map((row, y) => {
          const cells = row.map((cell, x) => {
            const type = TILE_TYPES[cell]
            const thickX = y % 4 === 0 ? " thickX" : "";
            const thickY = x % 4 === 0 ? " thickY" : "";
            return `<span class="cell${thickX}${thickY}" data-type="${type}"></span>`;
          }).join("");

          return render_row(cells);
        }).join("");

      const render_data = () => {
        const text = `[\n${map.map((row) => `[${row}],`).join("\n")}\n]`;
        data_pre.innerHTML = text;

        const encoded = encode(map);
        data_encode.innerHTML = JSON.stringify({
          levelData: encoded,
          mines: Object.keys(mines),
          humanBases: Object.keys(humanBases),
          cpuBases: Object.keys(cpuBases),
        }, null, 2);
      }
      render_data();

      map_div.innerHTML = render_map(map);

      const rows = document.querySelectorAll(".map .row")
      Array.from(rows).forEach((row, y) => {
        Array.from(row.querySelectorAll(".cell")).forEach((cell, x) => {
          const paint = () => {
            const current_type = cell.dataset.type;
            const type = get_selected_control();
            map[y][x] = TILE_TYPES.indexOf(type);

            const key = JSON.stringify([x, y]);
            if (selected_control === "mine") {
              mines[key] = true;
            } else {
              delete mines[key];
            }
            if (selected_control === "human-base") {
              humanBases[key] = true;
            } else {
              delete humanBases[key];
            }
            if (selected_control === "cpu-base") {
              cpuBases[key] = true;
            } else {
              delete cpuBases[key];
            }

            cell.dataset.type = type;
            render_data();
            const map_data = {
              levelData: encode(map),
              mines,
              humanBases,
              cpuBases,
            }
            window.localStorage.setItem('map', JSON.stringify(map_data));
          }
          cell.onmouseover = () => { if (selecting) paint() };
          cell.onclick = paint;
        });
      });


      Array.from(controls).forEach((control) => {
        control.onclick = function () {
          selected_control = this.classList[2];
          Array.from(controls).forEach((c) => {
            c.classList.remove("selected");
            control.classList.add("selected");
          });
        }
      });
    </script>
  </body>
</html>
